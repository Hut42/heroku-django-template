packages:
  yum:
    git: []
    postgresql96-devel: []
    libcurl-devel: []
files:
  "/etc/httpd/conf.d/wsgihacks.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      WSGIPassAuthorization on
  "/opt/elasticbeanstalk/tasks/taillogs.d/cloud-init.conf" :
    mode: "000755"
    owner: root
    group: root
    content: |
      /var/log/celery/*.log
container_commands:
  01_mkdir_for_log_and_pid:
    command: "mkdir -p /var/log/celery/ /var/run/celery/"
  02_upgrade_pip_for_venv:
    command: "/opt/python/run/venv/bin/pip install --upgrade pip"
  03_uninstall_pycurl:
    command: '/opt/python/run/venv/bin/pip uninstall -y pycurl'
  04_install_pycurl:
    command: 'PYCURL_SSL_LIBRARY=openssl && PYTHON_INSTALL_LAYOUT="" && /opt/python/run/venv/bin/pip install --compile --global-option="--with-openssl" --no-cache-dir pycurl===7.43.0.1'
  05_install_private_sources:
    command: "source /opt/python/run/venv/bin/activate && pip install -r requirements_private.txt"
  06_show_requirements:
    command: '/opt/python/run/venv/bin/pip freeze > /var/log/celery/requirements.log'
  07_test_pycurl:
    command: '/opt/python/run/venv/bin/python -c "import pycurl" > /var/log/celery/pycurl.log'
  08_celery_configure:
    command: "cp .ebextensions/celery-worker.sh /opt/elasticbeanstalk/hooks/appdeploy/post/ && chmod 744 /opt/elasticbeanstalk/hooks/appdeploy/post/celery-worker.sh"
    cwd: "/opt/python/ondeck/app"
  09_celery_run:
    command: "/opt/elasticbeanstalk/hooks/appdeploy/post/celery-worker.sh"
  10_migrate:
    command: "source /opt/python/run/venv/bin/activate && python manage.py migrate --noinput"
    leader_only: true
  11_collectstatic:
    command: "source /opt/python/run/venv/bin/activate && python manage.py collectstatic --noinput"
option_settings:
  "aws:elasticbeanstalk:container:python":
    WSGIPath: "{{ project_name }}/wsgi.py"
    NumProcesses: 3
    NumThreads: 20
  "aws:elasticbeanstalk:container:python:staticfiles":
    "/static/": "staticfiles/"
